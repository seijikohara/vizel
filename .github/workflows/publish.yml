name: Publish to npm

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 1.0.0, 1.0.0-beta.1)"
        required: true
        type: string
      dry-run:
        description: "Dry run (validate without publishing)"
        required: false
        type: boolean
        default: false
      skip-git:
        description: "Skip git tag and GitHub Release creation"
        required: false
        type: boolean
        default: false

# Required for npm trusted publishing (OIDC)
permissions:
  contents: write
  id-token: write

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate-version.outputs.version }}
    steps:
      - name: Validate version format
        id: validate-version
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          # Validate semver format (including prerelease)
          if [[ ! "$INPUT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$ ]]; then
            echo "::error::Invalid version format: $INPUT_VERSION"
            echo "Version must be in semver format (e.g., 1.0.0, 1.0.0-beta.1)"
            exit 1
          fi
          echo "version=$INPUT_VERSION" >> "$GITHUB_OUTPUT"
          echo "âœ… Version format valid: $INPUT_VERSION"

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if tag exists
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if git tag -l "v$INPUT_VERSION" | grep -q .; then
            echo "::error::Tag v$INPUT_VERSION already exists"
            exit 1
          fi
          echo "âœ… Tag v$INPUT_VERSION does not exist"

  test:
    name: Test (${{ matrix.framework }})
    runs-on: ubuntu-latest
    needs: [validate]
    strategy:
      fail-fast: true
      matrix:
        framework: [react, vue, svelte]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Run tests
        uses: ./.github/actions/test
        with:
          framework: ${{ matrix.framework }}
          browser: chromium

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [validate, test]
    environment: npm
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.DEV_AUTOMATION_APP_ID }}
          private-key: ${{ secrets.DEV_AUTOMATION_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update package versions
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          # Update version in all publishable packages
          pnpm --filter @vizel/core exec npm version "$VERSION" --no-git-tag-version
          pnpm --filter @vizel/react exec npm version "$VERSION" --no-git-tag-version
          pnpm --filter @vizel/vue exec npm version "$VERSION" --no-git-tag-version
          pnpm --filter @vizel/svelte exec npm version "$VERSION" --no-git-tag-version

          # Update internal dependency versions
          pnpm --filter @vizel/react pkg set "dependencies.@vizel/core=^$VERSION"
          pnpm --filter @vizel/vue pkg set "dependencies.@vizel/core=^$VERSION"
          pnpm --filter @vizel/svelte pkg set "dependencies.@vizel/core=^$VERSION"

          # Regenerate pnpm-lock.yaml with updated versions
          pnpm install --lockfile-only

          echo "âœ… Updated all packages to version $VERSION"

      - name: Build packages
        run: pnpm build

      - name: Publish (dry-run)
        if: ${{ inputs.dry-run }}
        run: |
          echo "ðŸ” Running dry-run publish..."
          pnpm --filter @vizel/core publish --dry-run --no-git-checks
          pnpm --filter @vizel/react publish --dry-run --no-git-checks
          pnpm --filter @vizel/vue publish --dry-run --no-git-checks
          pnpm --filter @vizel/svelte publish --dry-run --no-git-checks
          echo "âœ… Dry-run completed successfully"

      - name: Publish to npm
        if: ${{ !inputs.dry-run }}
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          # Determine npm tag for prerelease versions
          # e.g., 1.0.0-alpha.1 -> alpha, 1.0.0-beta.2 -> beta, 1.0.0 -> (empty)
          PRERELEASE_TAG=""
          if [[ "$VERSION" == *-* ]]; then
            # Extract prerelease identifier (e.g., alpha, beta, rc)
            PRERELEASE_TAG=$(echo "$VERSION" | sed 's/.*-\([a-zA-Z]*\).*/\1/')
          fi

          # Build publish command with optional tag
          PUBLISH_OPTS="--provenance --access public --no-git-checks"
          if [ -n "$PRERELEASE_TAG" ]; then
            PUBLISH_OPTS="$PUBLISH_OPTS --tag $PRERELEASE_TAG"
            echo "ðŸ“Œ Publishing with tag: $PRERELEASE_TAG"
          fi

          # Publish with provenance for supply chain security
          pnpm --filter @vizel/core publish $PUBLISH_OPTS
          pnpm --filter @vizel/react publish $PUBLISH_OPTS
          pnpm --filter @vizel/vue publish $PUBLISH_OPTS
          pnpm --filter @vizel/svelte publish $PUBLISH_OPTS
          echo "âœ… Published all packages to npm"

      - name: Commit version changes
        if: ${{ !inputs.dry-run && !inputs.skip-git }}
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          git add -A
          git commit -m "chore(release): v$VERSION"
          git tag "v$VERSION"
          git push origin main --tags
          echo "âœ… Committed and tagged v$VERSION"

      - name: Create GitHub Release
        if: ${{ !inputs.dry-run && !inputs.skip-git }}
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          tag_name: v${{ needs.validate.outputs.version }}
          name: v${{ needs.validate.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}

      - name: Summary
        env:
          VERSION: ${{ needs.validate.outputs.version }}
          DRY_RUN: ${{ inputs.dry-run }}
          SKIP_GIT: ${{ inputs.skip-git }}
        run: |
          echo "## ðŸ“¦ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" = "true" ]; then
            echo "ðŸ” **Mode:** Dry Run" >> $GITHUB_STEP_SUMMARY
          elif [ "$SKIP_GIT" = "true" ]; then
            echo "ðŸš€ **Mode:** Published (npm only, no git tag/release)" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš€ **Mode:** Published" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| @vizel/core | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| @vizel/react | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| @vizel/vue | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| @vizel/svelte | âœ… |" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" != "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Links" >> $GITHUB_STEP_SUMMARY
            echo "- [npm: @vizel/core](https://www.npmjs.com/package/@vizel/core)" >> $GITHUB_STEP_SUMMARY
            echo "- [npm: @vizel/react](https://www.npmjs.com/package/@vizel/react)" >> $GITHUB_STEP_SUMMARY
            echo "- [npm: @vizel/vue](https://www.npmjs.com/package/@vizel/vue)" >> $GITHUB_STEP_SUMMARY
            echo "- [npm: @vizel/svelte](https://www.npmjs.com/package/@vizel/svelte)" >> $GITHUB_STEP_SUMMARY
          fi
